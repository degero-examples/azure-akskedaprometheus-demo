# Kubernetes KEDA autoscaler workload demo and AKS infra

This is a demonstration of a multi app (2) deployment in Kubernetes with KEDA autoscaling on prometheus metrics.
It is also intentended to be used as a starter template to adapt your particular workload and test it locally for KEDA scaling needs.



> **⚠️ IMPORTANT ⚠️**  
> 
> This setup is designed for ease of use and demonstration purposes only. It is **not security hardened** and is **not suitable for production environments**.
>



Features include

- Ability to run locally to test your scaling needs without incuring hosting costs!
- Two nginx app deployments (app-one, app-two) with files served from a persistent volume
- Github token secret (for demonstration to follow to add your app secrets)
- Metrics collection (Prometheus) using annotation based scrape rules
- Option of private network load balancer or nginx ingress controller to access applications 
- KEDA scaler using Prometheus metrics for pod autoscaling
- Scale pods on http request count metric from nginx-ingress controller or pods in loadbalancer mode (using nginx prometheus exporter sidecar)
- Pod affinity/anti affinity options to ensure only one app per node (this is a demonstration, can be disabled)
- Secret creation for github token (for demonstration)


Azure features

- AKS node autoscaler with VirtualMachineScaleSets 5m idle scaledown
- Default workload nodepools scale to zero
- Azure files for workload persistant volume with Low cost tier 2GB default (to allow multiple scaled pods to access)
- AKS cluster, kubelet and KEDA user assigned identities for RBAC to resources (KEDA > Azure Monitor, Kublet > ACR, Cluster > VNET)
- VNet/NSG (port 80:443) configuration for private network load balancer access instead of public nginx-ingress
- Log analytics workspace for AKS log data collection
- Azure monitor workspace for Prometheus metrics (metric gathering defaults on)
- Azure Managed grafana for dashboards via Azure monitor (optional)
- Azure Container Regsitry (optional)
- AKS App routing addon (optional, there is a basic nginx ingress controller available by default. Requires a DNS A record to point to the ingress IP as it is not configurable to record metrics without a hostnae)

## Folders

```
azure-akskeda-demo
│
├── azd-hooks/ - scripts used by Azure Developer CLI to automate /infra and /workload deployment to azure
│
├── cluster-dependencies/
│   ├── azure/
│   │   ├── kube-system - azure monitor prometheus metrics configmap manifest (adjust this for what metrics to gather)
│   │   └── install-dependencies.sh - install all azure specific workload dependencies to the azure cluster
│   └── general/
│       ├── ingress-nginx - basic nginx ingress controller chart and install script
│       └── install-dependencies.sh - install all general workload dependencies to the cluster
│
├── infra/ - Bicep for Azure AKS + several other services
│   └── deploy-bicep.sh - deploy bicep and write resource detail outputs to /scripts/.env.azure 
│
├── localdev/ - Scripts, KIND configuration and manifests to run create cluster and install workload+dependencies on local docker
│
├── scripts/ - To install all Azure/ General cluster dependencies (in cluster-dependencies) and deploy /workload
│   └── .env.azure.sample - example env vars needed by deploy/undeploy script (autogenerated by deploy-bicep.sh)
│
├── workload/ - K8s workload
│   ├── chart/ - Helm chart for app deployment, persistent volume, scaling, loadbalancer, secrets, ingress etc
│   └── volume-data/ - Files for persistent volume demonstration apps in /workload/chart (app-one,app-two)
│
└── azure.yaml - Azure Developer CLI settings 
```

## Deployment

### Locally

Follow the workload deploy [README.md](./workload/README.md)

### Azure

#### Azure Developer CLI

> **⚠️ IMPORTANT ⚠️** 
>
> You will not be granted access to Grafana if you choose to enable when installing.
> 
> Either grant access following this [MSLearn Guide](https://learn.microsoft.com/en-us/azure/managed-grafana/how-to-manage-access-permissions-users-identities)
> 
> OR skip using the below  and  follow the [Manual (scipted) installation](./infra/README.md)



Install [AZ CLI installed](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest) and logged into azure (az login)

install [AZD CLI](https://learn.microsoft.com/en-us/azure/developer/azure-developer-cli/install-azd)
  
```sh
azd init
azd up
```

To access the app and use, see workload [README.md](./workload/README.md#check-system-is-running-correctly)


#### Manual deployment scripts

IMPORTANT: Resources in Azure (primarily the nodepool VMs) cost money, use with caution and stop / delete AKS or the whole RG when not using.

To deploy to Azure AKS:

- Follow the infra deploy [README.md](./infra/README.md)
- Then the workload deploy [README.md](./workload/README.md)

## Monitoring

### Grafana

There are some useful nginx ingress controller dashboards here:

https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/grafana/dashboards/nginx.json

https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/grafana/dashboards/request-handling-performance.json


And for metrics with no ingress controller (eg private network internal load balancer)

https://raw.githubusercontent.com/nginx/nginx-prometheus-exporter/refs/heads/main/grafana/dashboard.json

https://grafana.com/grafana/dashboards/14900-nginx/


KEDA metrics dashboard (set the namespace to default, ):

https://raw.githubusercontent.com/KEDAcore/KEDA/refs/heads/main/config/grafana/KEDA-dashboard.json